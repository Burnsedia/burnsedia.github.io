---
import { getCollection } from 'astro:content';
import FormattedDate from "./FormattedDate.astro"
import Card from '../shared/Card.astro'
const posts = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Collect unique tags
const allTags = Array.from(new Set(posts.flatMap(post => (post.data as any).tags || [])));
---
<section class="py-12">
  <div class="flex justify-center w-full">
    <div class="w-full max-w-6xl px-4">
      <div class="mb-8 flex flex-wrap gap-2 justify-center">
        <button class="btn btn-outline btn-sm" data-filter="all">All</button>
        {allTags.map(tag => <button class="btn btn-outline btn-sm" data-filter={tag}>{tag}</button>)}
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 items-center" id="posts-grid">
        {
          posts.map((post) => (
            <div class="py-4 px-4 post-item" data-tags={post.data.tags ? post.data.tags.join(',') : ''}>
              <FormattedDate date={post.data.pubDate} />
              <a href={`/blog/${post.slug}/`}><Card title={post.data.title} description={post.data.description} tags={post.data.tags} /></a>
            </div>
          ))
        }
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const filterButtons = document.querySelectorAll('[data-filter]');
    const postItems = document.querySelectorAll('.post-item');

    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        const filter = button.getAttribute('data-filter') || '';
        postItems.forEach(item => {
          const tags = (item as HTMLElement).getAttribute('data-tags')?.split(',') || [];
          if (filter === 'all' || tags.includes(filter)) {
            (item as HTMLElement).style.display = 'block';
          } else {
            (item as HTMLElement).style.display = 'none';
          }
        });
        // Update active button
        filterButtons.forEach(btn => (btn as HTMLElement).classList.remove('btn-active'));
        (button as HTMLElement).classList.add('btn-active');
      });
    });
  });
</script>
