---
const GA_ID = import.meta.env.PUBLIC_GA_ID;
const shouldLoad = import.meta.env.PROD && !!GA_ID;
---

{shouldLoad && (
  <>
    <!-- GA loader -->
    <script async src={`https://www.googletagmanager.com/gtag/js?id=${GA_ID}`}></script>

    <!-- Consent Mode v2 defaults (adjust to your policy or remove if not needed) -->
    <script is:inline set:html={`window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('consent','default',{
  ad_storage:'denied',
  ad_user_data:'denied',
  ad_personalization:'denied',
  analytics_storage:'granted'
});`}></script>

    <!-- GA config -->
    <script is:inline set:html={`window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config','${GA_ID}',{ send_page_view: true });`}></script>

    <!-- Track Astro View Transitions (ClientRouter) -->
    <script is:inline>
      const sendPV = () => {
        if (typeof gtag === 'function') {
          gtag('event', 'page_view', {
            page_location: location.href,
            page_path: location.pathname + location.search,
            page_title: document.title
          });
        }
      };
      addEventListener('astro:page-load', sendPV);
      addEventListener('astro:page-swap', sendPV);
    </script>
  </>
)}
