{"version":3,"file":"head-export-handler-for-ssr.js","names":["React","require","grabMatchParams","createElement","StaticQueryContext","headExportValidator","filterHeadProps","warnForInvalidTags","ServerLocation","Router","renderToString","parse","VALID_NODE_NAMES","headHandlerForSSR","pageComponent","setHeadComponents","setHtmlAttributes","setBodyAttributes","staticQueryContext","pageData","pagePath","Head","HeadRouteHandler","props","_props","result","params","location","pathname","pageContext","__params","routerElement","__BASE_PATH__","children","rawString","headNodes","childNodes","validHeadNodes","seenIds","Map","node","rawTagName","id","attributes","includes","element","__html","text","textContent","length","has","push","set","indexOfPreviouslyInsertedNode","get"],"sources":["../../head/head-export-handler-for-ssr.js"],"sourcesContent":["const React = require(`react`)\nconst { grabMatchParams } = require(`../find-path`)\nconst { createElement } = require(`react`)\nconst { StaticQueryContext } = require(`gatsby`)\nconst {\n  headExportValidator,\n  filterHeadProps,\n  warnForInvalidTags,\n} = require(`./utils`)\nconst { ServerLocation, Router } = require(`@gatsbyjs/reach-router`)\nconst { renderToString } = require(`react-dom/server`)\nconst { parse } = require(`node-html-parser`)\nconst { VALID_NODE_NAMES } = require(`./constants`)\n\nexport function headHandlerForSSR({\n  pageComponent,\n  setHeadComponents,\n  setHtmlAttributes,\n  setBodyAttributes,\n  staticQueryContext,\n  pageData,\n  pagePath,\n}) {\n  if (pageComponent?.Head) {\n    headExportValidator(pageComponent.Head)\n\n    function HeadRouteHandler(props) {\n      const _props = {\n        ...props,\n        ...pageData.result,\n        params: {\n          ...grabMatchParams(props.location.pathname),\n          ...(pageData.result?.pageContext?.__params || {}),\n        },\n      }\n\n      return createElement(pageComponent.Head, filterHeadProps(_props))\n    }\n\n    const routerElement = (\n      <StaticQueryContext.Provider value={staticQueryContext}>\n        <ServerLocation url={`${__BASE_PATH__}${pagePath}`}>\n          <Router\n            baseuri={__BASE_PATH__}\n            component={({ children }) => <>{children}</>}\n          >\n            <HeadRouteHandler path=\"/*\" />\n          </Router>\n        </ServerLocation>\n      </StaticQueryContext.Provider>\n    )\n\n    // extract head nodes from string\n    const rawString = renderToString(routerElement)\n    const headNodes = parse(rawString).childNodes\n\n    const validHeadNodes = []\n    const seenIds = new Map()\n\n    for (const node of headNodes) {\n      const { rawTagName } = node\n      const id = node.attributes?.id\n\n      if (!VALID_NODE_NAMES.includes(rawTagName)) {\n        warnForInvalidTags(rawTagName)\n        continue\n      }\n\n      if (rawTagName === `html`) {\n        setHtmlAttributes(node.attributes)\n        continue\n      }\n\n      if (rawTagName === `body`) {\n        setBodyAttributes(node.attributes)\n        continue\n      }\n\n      let element\n      const attributes = { ...node.attributes, \"data-gatsby-head\": true }\n\n      if (rawTagName === `script` || rawTagName === `style`) {\n        element = (\n          <node.rawTagName\n            {...attributes}\n            dangerouslySetInnerHTML={{\n              __html: node.text,\n            }}\n          />\n        )\n      } else {\n        element =\n          node.textContent.length > 0 ? (\n            <node.rawTagName {...attributes}>\n              {node.textContent}\n            </node.rawTagName>\n          ) : (\n            <node.rawTagName {...attributes} />\n          )\n      }\n\n      if (id) {\n        if (!seenIds.has(id)) {\n          validHeadNodes.push(element)\n          seenIds.set(id, validHeadNodes.length - 1)\n        } else {\n          const indexOfPreviouslyInsertedNode = seenIds.get(id)\n          validHeadNodes[indexOfPreviouslyInsertedNode] = element\n        }\n      } else {\n        validHeadNodes.push(element)\n      }\n    }\n\n    setHeadComponents(validHeadNodes)\n  }\n}\n"],"mappings":"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"}