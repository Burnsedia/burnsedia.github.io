{"version":3,"file":"head-export-handler-for-browser.js","names":["hiddenRoot","document","createElement","htmlAttributesList","Set","bodyAttributesList","removePrevHtmlAttributes","forEach","attributeName","elementTag","getElementsByTagName","removeAttribute","removePrevBodyAttributes","updateAttribute","tagName","attributeValue","attributesList","setAttribute","add","removePrevHeadElements","prevHeadNodes","querySelectorAll","node","parentNode","removeChild","onHeadRendered","validHeadNodes","seenIds","Map","childNodes","nodeName","toLowerCase","id","attributes","value","VALID_NODE_NAMES","includes","warnForInvalidTags","attribute","name","clonedNode","cloneNode","script","attr","innerHTML","has","push","set","length","indexOfPreviouslyInsertedNode","get","existingHeadElements","head","append","newHeadNodes","diffNodes","oldNodes","newNodes","onStale","onNew","process","env","BUILD_STAGE","originalConsoleError","console","error","bind","args","Array","isArray","undefined","observer","MutationObserver","observe","childList","characterData","subtree","headHandlerForBrowser","pageComponent","staticQueryResults","pageComponentProps","useEffect","Head","headExportValidator","render","reactDOMUtils","filterHeadProps"],"sources":["../../head/head-export-handler-for-browser.js"],"sourcesContent":["import React from \"react\"\nimport { useEffect } from \"react\"\nimport { StaticQueryContext } from \"gatsby\"\nimport { LocationProvider } from \"@gatsbyjs/reach-router\"\nimport { reactDOMUtils } from \"../react-dom-utils\"\nimport { FireCallbackInEffect } from \"./components/fire-callback-in-effect\"\nimport { VALID_NODE_NAMES } from \"./constants\"\nimport {\n  headExportValidator,\n  filterHeadProps,\n  warnForInvalidTags,\n  diffNodes,\n} from \"./utils\"\n\nconst hiddenRoot = document.createElement(`div`)\nconst htmlAttributesList = new Set()\nconst bodyAttributesList = new Set()\n\nconst removePrevHtmlAttributes = () => {\n  htmlAttributesList.forEach(attributeName => {\n    const elementTag = document.getElementsByTagName(`html`)[0]\n    elementTag.removeAttribute(attributeName)\n  })\n}\n\nconst removePrevBodyAttributes = () => {\n  bodyAttributesList.forEach(attributeName => {\n    const elementTag = document.getElementsByTagName(`body`)[0]\n    elementTag.removeAttribute(attributeName)\n  })\n}\n\nconst updateAttribute = (\n  tagName,\n  attributeName,\n  attributeValue,\n  attributesList\n) => {\n  const elementTag = document.getElementsByTagName(tagName)[0]\n\n  if (!elementTag) {\n    return\n  }\n\n  elementTag.setAttribute(attributeName, attributeValue)\n  attributesList.add(attributeName)\n}\n\nconst removePrevHeadElements = () => {\n  const prevHeadNodes = document.querySelectorAll(`[data-gatsby-head]`)\n\n  for (const node of prevHeadNodes) {\n    node.parentNode.removeChild(node)\n  }\n}\n\nconst onHeadRendered = () => {\n  const validHeadNodes = []\n  const seenIds = new Map()\n\n  for (const node of hiddenRoot.childNodes) {\n    const nodeName = node.nodeName.toLowerCase()\n    const id = node.attributes?.id?.value\n\n    if (!VALID_NODE_NAMES.includes(nodeName)) {\n      warnForInvalidTags(nodeName)\n      continue\n    }\n\n    if (nodeName === `html`) {\n      for (const attribute of node.attributes) {\n        updateAttribute(\n          `html`,\n          attribute.name,\n          attribute.value,\n          htmlAttributesList\n        )\n      }\n      continue\n    }\n\n    if (nodeName === `body`) {\n      for (const attribute of node.attributes) {\n        updateAttribute(\n          `body`,\n          attribute.name,\n          attribute.value,\n          bodyAttributesList\n        )\n      }\n      continue\n    }\n\n    let clonedNode = node.cloneNode(true)\n    clonedNode.setAttribute(`data-gatsby-head`, true)\n\n    // Create an element for scripts to make script work\n    if (clonedNode.nodeName.toLowerCase() === `script`) {\n      const script = document.createElement(`script`)\n      for (const attr of clonedNode.attributes) {\n        script.setAttribute(attr.name, attr.value)\n      }\n      script.innerHTML = clonedNode.innerHTML\n      clonedNode = script\n    }\n\n    if (id) {\n      if (!seenIds.has(id)) {\n        validHeadNodes.push(clonedNode)\n        seenIds.set(id, validHeadNodes.length - 1)\n      } else {\n        const indexOfPreviouslyInsertedNode = seenIds.get(id)\n        validHeadNodes[indexOfPreviouslyInsertedNode].parentNode?.removeChild(\n          validHeadNodes[indexOfPreviouslyInsertedNode]\n        )\n        validHeadNodes[indexOfPreviouslyInsertedNode] = clonedNode\n\n        continue\n      }\n    } else {\n      validHeadNodes.push(clonedNode)\n    }\n  }\n\n  const existingHeadElements = document.querySelectorAll(`[data-gatsby-head]`)\n\n  if (existingHeadElements.length === 0) {\n    document.head.append(...validHeadNodes)\n    return\n  }\n\n  const newHeadNodes = []\n  diffNodes({\n    oldNodes: existingHeadElements,\n    newNodes: validHeadNodes,\n    onStale: node => node.parentNode.removeChild(node),\n    onNew: node => newHeadNodes.push(node),\n  })\n\n  document.head.append(...newHeadNodes)\n}\n\nif (process.env.BUILD_STAGE === `develop`) {\n  // sigh ... <html> and <body> elements are not valid descedents of <div> (our hidden element)\n  // react-dom in dev mode will warn about this. There doesn't seem to be a way to render arbitrary\n  // user Head without hitting this issue (our hidden element could be just \"new Document()\", but\n  // this can only have 1 child, and we don't control what is being rendered so that's not an option)\n  // instead we continue to render to <div>, and just silence warnings for <html> and <body> elements\n  // https://github.com/facebook/react/blob/e2424f33b3ad727321fc12e75c5e94838e84c2b5/packages/react-dom-bindings/src/client/validateDOMNesting.js#L498-L520\n  const originalConsoleError = console.error.bind(console)\n  console.error = (...args) => {\n    if (\n      Array.isArray(args) &&\n      args.length >= 2 &&\n      args[0]?.includes(`validateDOMNesting(...): %s cannot appear as`) &&\n      (args[1] === `<html>` || args[1] === `<body>`)\n    ) {\n      return undefined\n    }\n    return originalConsoleError(...args)\n  }\n\n  // We set up observer to be able to regenerate <head> after react-refresh\n  // updates our hidden element.\n  const observer = new MutationObserver(onHeadRendered)\n  observer.observe(hiddenRoot, {\n    attributes: true,\n    childList: true,\n    characterData: true,\n    subtree: true,\n  })\n}\n\nexport function headHandlerForBrowser({\n  pageComponent,\n  staticQueryResults,\n  pageComponentProps,\n}) {\n  useEffect(() => {\n    if (pageComponent?.Head) {\n      headExportValidator(pageComponent.Head)\n\n      const { render } = reactDOMUtils()\n\n      const Head = pageComponent.Head\n\n      render(\n        // just a hack to call the callback after react has done first render\n        // Note: In dev, we call onHeadRendered twice( in FireCallbackInEffect and after mutualution observer dectects initail render into hiddenRoot) this is for hot reloading\n        // In Prod we only call onHeadRendered in FireCallbackInEffect to render to head\n        <FireCallbackInEffect callback={onHeadRendered}>\n          <StaticQueryContext.Provider value={staticQueryResults}>\n            <LocationProvider>\n              <Head {...filterHeadProps(pageComponentProps)} />\n            </LocationProvider>\n          </StaticQueryContext.Provider>\n        </FireCallbackInEffect>,\n        hiddenRoot\n      )\n    }\n\n    return () => {\n      removePrevHeadElements()\n      removePrevHtmlAttributes()\n      removePrevBodyAttributes()\n    }\n  })\n}\n"],"mappings":"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"}